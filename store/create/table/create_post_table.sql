DROP TABLE IF EXISTS post_labels;
DROP TABLE IF EXISTS category_locales;
DROP TABLE IF EXISTS posts;
DROP TABLE IF EXISTS categories;
DROP TABLE IF EXISTS labels;
DROP TABLE IF EXISTS post_states;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE categories (
	id SMALLINT GENERATED BY DEFAULT AS IDENTITY,
	is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
	PRIMARY KEY (id)
);

CREATE TABLE category_locales (
	category_id SMALLINT NOT NULL,
	locale VARCHAR(50) NOT NULL,
	name VARCHAR(50) NOT NULL,
	PRIMARY KEY (category_id, locale),
	CONSTRAINT fk_cl_categories FOREIGN KEY (category_id)
		REFERENCES categories (id)
		ON UPDATE CASCADE
		ON DELETE CASCADE
);

INSERT INTO categories
VALUES (1),(2),(3),(4),(5),(6);

INSERT INTO category_locales
VALUES
	(1, 'en', 'Thoughts'),
	(1, 'zh', '思考'),
	(2, 'en', 'Technology'),
	(2, 'zh', '技术'),
	(3, 'en', 'Finance'),
	(3, 'zh', '金融'),
	(4, 'en', 'Travel'),
	(4, 'zh', '旅行'),
	(5, 'en', 'Reading'),
	(5, 'zh', '读书'),
	(6, 'en', 'Personal'),
	(6, 'zh', '个人');

CREATE TABLE labels (
	id VARCHAR(50) NOT NULL,
	name VARCHAR(50) NOT NULL,
	PRIMARY KEY (id),
	CONSTRAINT uq_name UNIQUE (name)
);

CREATE TABLE post_states (
	id SMALLINT GENERATED BY DEFAULT AS IDENTITY,
	name VARCHAR(50) NOT NULL,
	PRIMARY KEY (id)
);

INSERT INTO post_states
VALUES
	(1, 'draft'),
	(2, 'published'),
	(3, 'removed'),
	(4, 'deleted');

CREATE TABLE posts (
	id UUID NOT NULL DEFAULT uuid_generate_v4(),
	slug VARCHAR(200) NOT NULL,
	introduction TEXT NOT NULL DEFAULT '',
	title VARCHAR(200) NOT NULL,
	content TEXT NOT NULL,
	author VARCHAR(200) NOT NULL,
	create_time TIMESTAMP NOT NULL,
	last_edited_time TIMESTAMP NOT NULL,
	word_count SMALLINT NOT NULL,
	reading_time SMALLINT NOT NULL,
	image_url VARCHAR(1024) NOT NULL DEFAULT '',
	category_id SMALLINT NOT NULL,
	state SMALLINT NOT NULL,
	is_featured BOOLEAN NOT NULL DEFAULT FALSE,
	PRIMARY KEY (id),
	CONSTRAINT uq_slug UNIQUE (slug),
	CONSTRAINT fk_posts_categories FOREIGN KEY (category_id)
		REFERENCES categories (id)
		ON UPDATE CASCADE
		ON DELETE NO ACTION,
	CONSTRAINT fk_posts_ps FOREIGN KEY (state)
		REFERENCES post_states (id)
		ON UPDATE CASCADE
		ON DELETE NO ACTION
);

CREATE TABLE post_labels (
	post_id UUID NOT NULL DEFAULT uuid_generate_v4(),
	label_id VARCHAR(50) NOT NULL,
	PRIMARY KEY (post_id, label_id),
	CONSTRAINT fk_pl_posts FOREIGN KEY (post_id)
		REFERENCES posts (id)
		ON UPDATE CASCADE
		ON DELETE CASCADE,
	CONSTRAINT fk_pl_labels FOREIGN KEY (label_id)
		REFERENCES labels (id)
		ON UPDATE CASCADE
		ON DELETE CASCADE
)
